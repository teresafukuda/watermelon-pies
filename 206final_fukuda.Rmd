---
title: "ESM206 Final"
author: "Teresa Fukuda"
date: "12/7/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages and data, include=FALSE}

# load packages

library(tidyverse) # wrangle and look at data 
library(janitor) # clean up names to snakecase yay
library(car) # vif
library(effsize) # compute effect sizes
library(corrplot) # For correlation matrices
library(kableExtra) # making tables with kable()
library(stargazer) # Linear regression output table

# load data

ca_county_pesticides <- read_csv("ca_county_pesticides.csv")
climate_opinion <- read_csv("climate_opinion.csv")
pesticide_residues<- read_csv("PesticideResidues.csv")
tmas_df <- read_csv("tmas_df.csv")
ucsb_climate <- read_csv("ucsb_climate.csv")


```


### Task 1. Climate Change Opinions
a. I chose to create a multiple linear regression model because the relationships between the input variables and the output (happening) could be linear, and there is more than one explanatory variable that I think contributes to the outcome of the output variable. 

b. An exploratory correlation matrix for all continuous variables (make it readable.
```{r Task 1b exploration, include=FALSE}

# For Task 1: Explore relationships between climate change perspectives, information exposure, education attainment, poverty levels and coastline on the proportion of people who believe that global warming is happening (i.e., ‘happening’ should be your dependent variable).

# Exploratory data visualization

climate_opinion_vis <- ggplot (climate_opinion)+
  geom_point(aes(y=happening, x=poverty_rate)) +
  geom_point(aes(y=happening, x=bachelors), color="red") +
  geom_point(aes(y=happening, x=mediaweekly), color="blue") +
  geom_point(aes(y=happening, x=discuss), color="orange") +
  geom_point(aes(y=happening, x=consensus), color="green")
  
climate_opinion_vis

# create a df with only the numeric data
pair_df <- climate_opinion[2:7]

# look at the pairwise graphs of the data from pairs_df
pairs(pair_df)
# could be linear relationship for most; the poverty_rate plots look more blob than linear

```

```{r 1b, echo=FALSE}


# create a correlation matrix df to use in the corrplot
cor_df <- cor(pair_df)

# visually look at this using corrplot function to make correlation matrix
corrplot(cor_df, #input matrix of correlation data, not original data
         type= "upper",# only shows upper half of matrix (so as not to repeat data)
         method= "ellipse",
         tl.col="black", # change label text color and size
         tl.cex=0.5) 
```


c. A finalized table of results for your analyses (you may present more than one model), with a figure caption.

```{r linear regression, include=FALSE}

# Create a multiple linear regression for climate opinions (happening is output, which is a continuous measurable variable)

# Want the reference level to be California

climate_opinion$GeoName <- factor(climate_opinion$GeoName)
climate_opinion$GeoName <- fct_relevel(climate_opinion$GeoName, "California")

# Saturated model-- all variables
climate_opinion_lm1 <- lm (happening ~ GeoName+consensus+discuss+mediaweekly+bachelors+poverty_rate+coastline, data=climate_opinion)
# error: singularities
summary(climate_opinion_lm1)


# trying another model without consensus or geoname (geoname might not be important relative to coastline), because of a very strong correlation with happening
climate_opinion_lm2 <- lm (happening ~ discuss+mediaweekly+bachelors+poverty_rate+coastline, data=climate_opinion)

summary(climate_opinion_lm2)

plot(climate_opinion_lm2)
# nothing too alarming here

AIC(climate_opinion_lm2)
vif(climate_opinion_lm2)
    
    
#but what if I keep geoname and remove coastline?
climate_opinion_lm3 <- lm (happening ~ discuss+mediaweekly+bachelors+poverty_rate+GeoName, data=climate_opinion)

# GeoName coefficients don't really make sense... living in Nevada all else the same shouldn't make someone believe in climate change that much more. Nope. I don't think this model is very good... 

summary(climate_opinion_lm3)


```
```{r, echo=FALSE, results="asis"}

stargazer(climate_opinion_lm2, type = "html")

```
 
d. Choose two coefficients in the model that you find interesting (either because they are expected or unexpected). For each, write a single sentence explaining what that coefficient means in terms of an expected change in the dependent variable.

e. Based on diagnostic plots, describe (1 - 2 sentences) if you have concerns about heteroscedasticity or normality of residuals for your model(s). You do not need to include the diagnostic plots in your final document.

### Task 2. UCSB Campus Climate Survey-- Respectfulness by Respondent Race/Ethnicity

a. In 1 - 2 sentences: What type of analysis will you perform? In the context of this task, what research question will your analysis answer?

b. A one sentence finalized statement of the statistical results for the analysis you decided on in (a). You are not expected to do post-hoc testing, but you can if you want to.

```{r, echo=FALSE}

# Looking at all continuous data, with more than two variables; going to use chi squared. This will answer the question: Is there a significant association between perceived respect on campus between racial groups? 

# H0: No association; proportions of answers are similar across racial groups
# H1: There is an association between race and perceived respect


# make names in df snakecase
ucsb_climate_a <- ucsb_climate %>%
  clean_names() %>% 
  select(-"x1") %>% 
  as.matrix(.)

ucsb_climate_x2 <- chisq.test(ucsb_climate_a)
ucsb_climate_x2
# x-squared = 1489.6, df = 18, p-value <2.2e-16
# p value < 0.001, significant association between race/ehtnicity and perception of respect on campus



rownames(ucsb_climate_a)<- c("African/African American" ,"American Indian/Native Alaskan","Asian/Asian American" ,"Hispanic/Latino","Middle Eastern/Southeast Asian/Southern African","Pacific Islander","White")

campusclimate_prop <- prop.table(ucsb_climate_a,1)
campusclimate_prop

# c. A finalized figure or table that clearly shows counts and/or proportions of respondents’ perceptions of campus respect for each race/ethnicity reporting. Include a caption.

campusclimate_table <- kable(round(campusclimate_prop,3)) %>% 
   kable_styling(bootstrap_option = c("striped", "hover"), full_width = FALSE)

campusclimate_table

# d. A concise 2 - 3 sentence discussion of interesting differences and/or similarities across groups, and notable big picture trends.



```
d. A concise 2 - 3 sentence discussion of interesting differences and/or similarities across groups, and notable big picture trends.

### Task 3. Effect of sex and age on self-consciousness (Taylor Manifest Anxiety Scale)

a. A finalized table of model results and statistics. Include a table caption.

```{r, inclue=FALSE}
# For Task 3, explore effects of sex and age on probability that a person will respond True or False to the statement: “I am usually self-conscious.” Data in ‘tmas_df.csv’ are accessed and updated from openpsychometrics.org (a cool site for open-source survey data).

# exploratory data analysis

# plot of age and self-conscious
age_self_plot <- ggplot(tmas_df, aes(x=age, y=response))+
  geom_point(aes(color=sex_mf))
age_self_plot 
# these look very similar in spread... 

# manipulate dataframe so that true=1, false=0
tmas_new <- tmas_df %>% 
  mutate(tf=case_when(.$response=="True"~1,
                      TRUE~0))


# binary logistic regression!

taylorscale_blr <- glm(tf ~ age + sex_mf, family= "binomial", data=tmas_new)

summary(taylorscale_blr)

# both coefficients for age and sex are negative, showing that based on the table, male self consciousness is lower and increase in age led to a decrease in self consciousness


```
```{r 3a table, results="asis"}

stargazer(taylorscale_blr, type = "html")

```



b. A finalized graph showing predicted probabilities for True/False responses, separated by sex over a range of ages, with standard errors included. You do NOT need to include a figure caption.

```{r, echo=FALSE}

# range of ages is from 14 - 94, look at both of these for male and female

#first create a new df with these predicted values

seq_age <- rep(seq(from = 14, to = 94), 2) # Create a vector with sequence from 0 to 100, twice (one will be "Male" and one will be "Female")

f_81 <- rep("Female", 81) # Repeat 'Female' 81 times (to match years data)
m_81 <- rep("Male", 81) # Repeat 'Male' 81 times
mf_81 <- c(f_81, m_81) # Combine them into a single vector

tmas_predict_df <- data.frame(seq_age, mf_81) # MUST make column names match variables in the model!
colnames(tmas_predict_df) <- c("age","sex_mf")

predicted_probs <- predict(taylorscale_blr, newdata=tmas_predict_df, type= "response", se.fit=TRUE) # se.fit=TRUE calculates a standard error

# Coerce outcome into data frame. 

graph_data <- data.frame (tmas_predict_df, predicted_probs$fit, predicted_probs$se.fit)

colnames(graph_data) <- c("Age","Sex","probability","SE")

# make a plot of the data for ages range 14 to 94

tmas_plot <- ggplot(graph_data, aes(x= Age, y= probability)) +
  geom_line(aes(color=Sex)) + # tells R that there are different series 
  geom_ribbon(aes(ymin= probability-SE, ymax= probability +SE, fill=Sex), alpha = 0.4)


tmas_plot

```

c. In 2 - 3 sentences, describe trends/differences/similarities that are seen in the graph, and how those align with the results you report in (a).


### Task 4. Pyraclostrobin residue on crops

```{r presticide exploration, include=FALSE}

# The question: is there a significant difference in pyraclostrobin concentrations in strawberries and carrots?

# df for this is pesticide_residues

# isolate the columns of interest: "COMMODITY" "CHEMICAL DETECTED (IF ANY)" "AMOUNT OF CHEMICAL DETECTED (PPM)" and filter out all NA values, and keep only "STRAWBERRY (ALL OR UNSPEC)" and "CARROTS(ROOT CROP)"
pesticides_new <- pesticide_residues %>% 
  select ("COMMODITY","CHEMICAL DETECTED (IF ANY)","AMOUNT OF CHEMICAL DETECTED (PPM)") %>% 
  filter (.$"CHEMICAL DETECTED (IF ANY)" == "PYRACLOSTROBIN") %>% 
  filter(.$"COMMODITY" == "STRAWBERRY (ALL OR UNSPEC)" |
           .$"COMMODITY" == "CARROTS (ROOT CROP)")
  

# rename columns in pesticides_new to "commodity","chemical_name","chem_amt"
colnames(pesticides_new)<- (c("commodity","chemical_name","chem_amt"))

# exploratory data visualization

pesticide_plot <- ggplot(pesticides_new, aes(x=commodity, y=chem_amt), legend=FALSE) +
  geom_point()
pesticide_plot

# well these look unequal, that's for sure. I have two groups here and a measured continuous variable for each. I think that's a situation where I would want to compare; Is there a significant difference between the mean pesticide amount on each crop? I'm going to see how normal the data is, and if I can perhaps use a t-test
#histograms of chemical amt by crop
pesticide_plot2 <- ggplot(pesticides_new, aes(x=chem_amt)) +
  geom_histogram() +
  facet_wrap(~commodity, scale="free")
pesticide_plot2
# these look very non-normal

#qq plots
pesticide_plot3 <- ggplot(pesticides_new, aes(sample=chem_amt)) +
  geom_qq() +
  facet_wrap(~commodity, scale="free")
pesticide_plot3
# these look non-normal 

# summary table for the pesticide data by crop
pest_summary <- pesticides_new %>% 
  group_by(commodity) %>% 
  summarize(mean= mean(chem_amt),
            median=median(chem_amt),
            n=n()
            )

# I am therefore going to use the mann-whitney u non parametric test

#want comparison of means so do Mann Whitney U
#H0: Ranks are equal
#HA: ranks are different

# make data frame w columns for each commodity
strawb <- pesticides_new %>% 
  select(commodity,chem_amt) %>% 
  filter(commodity == "STRAWBERRY (ALL OR UNSPEC)") %>% 
  select (chem_amt)

carrot <- pesticides_new %>% 
  select(commodity,chem_amt) %>% 
  filter(commodity == "CARROTS (ROOT CROP)") %>% 
  select (chem_amt)
  

pesticide_test <- wilcox.test(strawb$chem_amt, carrot$chem_amt, alternative= c("two.sided"))
pesticide_test


```

a. Summarize/describe any exploratory analyses that you performed in order to decide on the appropriate test to compare concentrations. Include exploratory graphs that informed your decision (you don’t need to finalize or include figure captions here). Based on those outcomes, justify your choice of test.


b. In 1-2 sentences, state your final results in a format that would be suitable for publication in a professional report or article.



### Task 5. Pesticides by County, California
```{r pesticide finalized plot, echo=FALSE}

# top ten CA counties ranked by pounds applied per mile plot

county_pest_plot <- ca_county_pesticides %>% 
  clean_names() %>% #make all names snake case
  data.frame(.) %>% 
  mutate(pest_per_mile=pounds_active_pesticide_ingredient_used/county_area_square_miles) %>%  # add a column for pounds pesticide per square mile area in county
  arrange(-.$pest_per_mile) %>% # arrange by pesticide per area
  head(10) %>% #keep the top ten counties by pesticide per area
  ggplot(.,aes(x=reorder(county,pest_per_mile), y=pest_per_mile)) + #create a plot of county and pesticide use per mile, ordered by pest per mile
  geom_col(fill="grey49") + # column graph w slightly lighter bars than default 
  coord_flip() +
   theme(panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(), 
      panel.background = element_blank(),
      axis.line = element_line(colour = "black"),
      text = element_text(family = "Times New Roman")) + #aesthetics
  labs(x = "County",
       y = "Pesticide Applied"~(lbs/mi^2)) + #labels for the axes-- coord flip switched these earlier, so xlab is for the y axis now
       theme(legend.position = "none") + #no legend 
  scale_y_continuous(expand = c(0,0))+ # move data to align w y axis
  ggtitle("Top Ten Counties in California by Pesticide Use in 2014")

county_pest_plot
```


